{% extends 'base.html' %}

{% block content %}

    <script>

        var is_first_refresh_ant_rotator = true;
        var is_first_refresh_radio = true;

        function refresh() {

            $.ajax({
                url: "{{ url_for("route_api_ham_ant_rotator") }}",
                success: function (data) {
                    $("#lbl_ant_rot_azimuth").text(data["azimuth"]);
                    $("#lbl_ant_rot_elevation").text(data["elevation"]);
                    $("#lbl_ant_rot_last_updated").text(data["last_updated"]);

                    if (is_first_refresh_ant_rotator) {
                        $("#form_ant_rot_azimuth").val(data["azimuth"]);
                        $("#form_ant_rot_elevation").val(data["elevation"]);
                        is_first_refresh_ant_rotator = false;
                    }
                }
            });

            $.ajax({
                url: "{{ url_for("route_api_ham_radio") }}",
                success: function (data) {
                    $("#lbl_radio_frequency").text(data["frequency"]);
                    $("#lbl_radio_power").text(data["power"]);
                    $("#lbl_radio_mode").text(data["mode"]);
                    $("#lbl_radio_is_transmitting").text(data["is_transmitting"]);
                    $("#lbl_radio_last_updated").text(data["last_updated"]);

                    if (is_first_refresh_radio) {
                        $("#form_radio_frequency").val(data["frequency"]);
                        $("#form_radio_power").val(data["power"]);
                        $("#form_radio_mode").val(data["mode"]);
                        is_first_refresh_radio = false;
                    }

                }
            });

        }

        var background_refresh = -1;

        function start_refresh() {
            if (background_refresh !== -1) {
                return;
            }
            background_refresh = window.setInterval(function () {
                refresh();
            }, 1000);

            Toastify({
                text: "Start Background Refresh",
                position: "center",
                gravity: "bottom",
                duration: 5000,
                style: {
                    background: "green",
                },
            }).showToast();
        }

        function stop_refresh() {
            window.clearInterval(background_refresh);
            background_refresh = -1;
            Toastify({
                text: "Stop Background Refresh",
                position: "center",
                gravity: "bottom",
                duration: 5000,
                style: {
                    background: "red",
                },
            }).showToast();
        }

    </script>

    <script>

        function form_set_ant_rot_azimuth() {
            let azimuth = $("#form_ant_rot_azimuth").val();

            $.ajax({
                url: '{{ url_for("route_api_ham_ant_rotator") }}',
                type: "POST",
                data: JSON.stringify({
                    azimuth: azimuth,
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function () {

                }
            });

            Toastify({
                text: "Set Antenna Rotator: Azimuth=" + azimuth,
                position: "center",
                gravity: "bottom",
                duration: 5000,
                style: {
                    background: "blue",
                },
            }).showToast();

        }

        function form_set_ant_rot_elevation() {
            let elevation = $("#form_ant_rot_elevation").val();

            $.ajax({
                url: '{{ url_for("route_api_ham_ant_rotator") }}',
                type: "POST",
                data: JSON.stringify({
                    elevation: elevation,
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function () {

                }
            });

            Toastify({
                text: "Set Antenna Rotator: Elevation=" + elevation,
                position: "center",
                gravity: "bottom",
                duration: 5000,
                style: {
                    background: "blue",
                },
            }).showToast();

        }

        function form_radio_set_frequency() {
            let frequency = $("#form_radio_frequency").val();

            $.ajax({
                url: '{{ url_for("route_api_ham_radio") }}',
                type: "POST",
                data: JSON.stringify({
                    frequency: frequency,
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function () {

                }
            });

            Toastify({
                text: "Set Radio: Frequency=" + frequency,
                position: "center",
                gravity: "bottom",
                duration: 5000,
                style: {
                    background: "blue",
                },
            }).showToast();

        }

        function form_radio_set_power() {
            let power = $("#form_radio_power").val();

            $.ajax({
                url: '{{ url_for("route_api_ham_radio") }}',
                type: "POST",
                data: JSON.stringify({
                    power: power,
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function () {

                }
            });

            Toastify({
                text: "Set Radio: Power=" + power,
                position: "center",
                gravity: "bottom",
                duration: 5000,
                style: {
                    background: "blue",
                },
            }).showToast();

        }

        function form_radio_set_mode() {
            let mode = $("#form_radio_mode").val();

            $.ajax({
                url: '{{ url_for("route_api_ham_radio") }}',
                type: "POST",
                data: JSON.stringify({
                    mode: mode,
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function () {

                }
            });

            Toastify({
                text: "Set Radio: Mode=" + mode,
                position: "center",
                gravity: "bottom",
                duration: 5000,
                style: {
                    background: "blue",
                },
            }).showToast();

        }

        function form_radio_start_tx() {

            $.ajax({
                url: '{{ url_for("route_api_ham_radio_start_tx") }}',
                type: "POST",
                success: function () {
                    Toastify({
                        text: "Start Transmitting",
                        position: "center",
                        gravity: "bottom",
                        duration: 5000,
                        style: {
                            background: "blue",
                        },
                    }).showToast();
                }
            });


        }

        function form_radio_stop_tx() {

            $.ajax({
                url: '{{ url_for("route_api_ham_radio_stop_tx") }}',
                type: "POST",
                success: function () {
                    Toastify({
                        text: "Stop Transmitting",
                        position: "center",
                        gravity: "bottom",
                        duration: 5000,
                        style: {
                            background: "blue",
                        },
                    }).showToast();
                }
            });

        }

    </script>

    <p>This page is used to display the parameters and to control the antenna and the radio.</p>

    <h3>Page Control</h3>

    <ul>
        <li><a href="javascript:refresh()">Manual Refresh</a></li>
        <li><a href="javascript:start_refresh()">Start Background Refresh</a></li>
        <li><a href="javascript:stop_refresh()">Stop Background Refresh</a></li>
    </ul>

    <h3>Antenna Rotator</h3>

    <h4>Overview</h4>

    <table class="tab-content">
        <tr>
            <td>Last Updated (UTC)</td>
            <td><label id="lbl_ant_rot_last_updated">tbd</label></td>
        </tr>
        <tr>
            <td>Azimuth (Degree)</td>
            <td><label id="lbl_ant_rot_azimuth">tbd</label></td>
        </tr>
        <tr>
            <td>Elevation (Degree)</td>
            <td><label id="lbl_ant_rot_elevation">tbd</label></td>
        </tr>
    </table>

    <h4>RX-Calculator</h4>

    <p>Automatically calculates the parameters for the <i>Control</i> section.<br>Displays the information and
        position on a map.</p>

    <form action="javascript:calc_rx_ant_parmas_maidenhead()">
        <table class="tab-content">
            <tr>
                <td class="tab-first-col">Maidenhead</td>
                <td class="tab-second-col"><input type="text" class="input-same-width"
                                                  id="form_calc_maidenhead"
                                                  name="form_calc_maidenhead"
                                                  value="{{ page_tx_maidenhead }}"></td>
            </tr>
            <tr>
                <td></td>
                <td><input type="submit" value="Calculate on Locator"></td>
            </tr>
        </table>
    </form>

    <br>

    <form>
        <table class="tab-content">
            <tr>
                <td class="tab-first-col">GPS Latitude</td>
                <td class="tab-second-col"><input type="text" class="input-same-width"
                                                  id="form_calc_gps_lat"
                                                  name="form_calc_gps_lat"
                                                  value="{{ page_tx_latitude }}"></td>
            </tr>
            <tr>
                <td class="tab-first-col">GPS Longitude</td>
                <td class="tab-second-col"><input type="text" class="input-same-width"
                                                  id="form_calc_gps_lon"
                                                  name="form_calc_gps_lon"
                                                  value="{{ page_tx_longitude }}"></td>
            </tr>
            <tr>
                <td></td>
                <td><input type="submit" value="Calculate on Lat/Lon"></td>
            </tr>
        </table>
    </form>

    <br>

    <table class="tab-content">
        <tr>
            <td class="tab-first-col">RX-Distance (km)</td>
            <td class="tab-second">
                <label id="lbl_calc_rx_distance">0</label>
            </td>
        </tr>
        <tr>
            <td class="tab-first-col">RX-Azimuth (Degree)</td>
            <td class="tab-second">
                <label id="lbl_calc_rx_azimuth">0</label>
            </td>
        </tr>
    </table>

    <br>

    <link rel="stylesheet" href="{{ url_for('static',filename='styles/leaflet.css') }}"/>
    <div id="map"></div>
    <script src="{{ url_for('static',filename='scripts/leaflet.js') }}"></script>
    <script>
        var map = L.map('map').setView([{{ page_tx_latitude }}, {{ page_tx_longitude }}], 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        var marker = L.marker([{{ page_tx_latitude }}, {{ page_tx_longitude }}]).addTo(map)
            .bindPopup('TX')
            .openPopup();

        function renew_map(lat, lon) {

            map.setView([lat, lon], 17);

            // Alten Marker entfernen
            map.removeLayer(marker);

            L.marker([{{ page_tx_latitude }}, {{ page_tx_longitude }}]).addTo(map)
                .bindPopup('TX')
                .openPopup();

            marker = L.marker([lat, lon]).addTo(map)
                .bindPopup('RX')
                .openPopup();


        }
    </script>

    <script>

        function calc_rx_ant_parmas_maidenhead() {
            let maidenhead = $("#form_calc_maidenhead").val();

            $.ajax({
                url: '{{ url_for("route_api_ham_rx_ant_params") }}',
                type: "POST",
                data: JSON.stringify({
                    maidenhead: maidenhead,
                }),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $("#lbl_calc_rx_distance").text(data["distance"]);
                    $("#lbl_calc_rx_azimuth").text(data["azimuth"]);

                    $("#form_calc_gps_lat").val(data["latitude"]);
                    $("#form_calc_gps_lon").val(data["longitude"]);

                    renew_map(data["latitude"], data["longitude"]);

                    $("#form_ant_rot_azimuth").val(data["azimuth"]);
                }
            });

        }

    </script>

    <h4>Control</h4>

    <form action="javascript:form_set_ant_rot_azimuth()">
        <table class="tab-content">
            <tr>
                <td class="tab-first-col">Azimuth (Degree)</td>
                <td class="tab-second-col"><input type="text" class="input-same-width"
                                                  id="form_ant_rot_azimuth"
                                                  name="form_ant_rot_azimuth"
                                                  value="0"></td>
                <td><input type="submit" value="Set"></td>
            </tr>
        </table>
    </form>

    <form action="javascript:form_set_ant_rot_elevation()">
        <table class="tab-content">
            <tr>
                <td class="tab-first-col">Elevation (Degree)</td>
                <td class="tab-second-col"><input type="text" class="input-same-width"
                                                  id="form_ant_rot_elevation"
                                                  name="form_ant_rot_elevation"
                                                  value="0"></td>
                <td><input type="submit" value="Set"></td>
            </tr>
        </table>
    </form>

    <h3>Radio</h3>

    <h4>Overview</h4>

    <table class="tab-content">
        <tr>
            <td>Last Updated (UTC)</td>
            <td><label id="lbl_radio_last_updated">tbd</label></td>
        </tr>
        <tr>
            <td>Frequency (Hz)</td>
            <td><label id="lbl_radio_frequency">tbd</label></td>
        </tr>
        <tr>
            <td>Power (%)</td>
            <td><label id="lbl_radio_power">tbd</label></td>
        </tr>
        <tr>
            <td>Mode</td>
            <td><label id="lbl_radio_mode">tbd</label></td>
        </tr>
        <tr>
            <td>Is Transmitting</td>
            <td><label id="lbl_radio_is_transmitting">tbd</label></td>
        </tr>
    </table>

    <h4>Control</h4>

    <p>The transmission stops automatically {{ page_tx_wav_duration }} seconds after the start of the transmission.</p>

    <ul>
        <li><a href="javascript:form_radio_start_tx()">Start Transmitting</a></li>
        <li><a href="javascript:form_radio_stop_tx()">Stop Transmitting</a></li>
    </ul>

    <form action="javascript:form_radio_set_frequency()">
        <table class="tab-content">
            <tr>
                <td class="tab-first-col">Frequency (Hz)</td>
                <td class="tab-second-col"><input type="text" class="input-same-width"
                                                  id="form_radio_frequency"
                                                  name="form_radio_frequency"
                                                  value="0"></td>
                <td><input type="submit" value="Set"></td>
            </tr>
        </table>
    </form>

    <form action="javascript:form_radio_set_power()">
        <table class="tab-content">
            <tr>
                <td class="tab-first-col">Power (%)</td>
                <td class="tab-second-col"><input type="text" class="input-same-width"
                                                  id="form_radio_power"
                                                  name="form_radio_power"
                                                  value="0"></td>
                <td><input type="submit" value="Set"></td>
            </tr>
        </table>
    </form>

    <form action="javascript:form_radio_set_mode()">
        <table class="tab-content">
            <tr>
                <td class="tab-first-col">Mode</td>
                <td class="tab-second-col">
                    <select
                            class="input-same-width"
                            name="form_radio_mode"
                            id="form_radio_mode">
                        <option value="AM">AM</option>
                        <option value="FM">FM</option>
                        <option value="USB">USB</option>
                        <option value="LSB">LSB</option>
                        <option value="CW">CW</option>
                    </select>
                </td>
                <td><input type="submit" value="Set"></td>
            </tr>
        </table>
    </form>


    <script>
        start_refresh();
    </script>

{% endblock %}